#!/usr/bin/purc

# RESULT: bx00112233445566778899AABBCCDDEEFF

<hvml target="void">
    <head>
        <init as 'bytes' with bx00112233445566778899AABBCCDDEEFF />
    </head>

    <body>

        <init as 'result' with {} />

        <init as 'dgramSocket' with $SOCKET.dgram('local:///var/tmp/hvml-dgram-server', 'default') >
            <catch for `ANY`>
                <exit with "Server failed with $?.name when calling SOCKET.dgram()" />
            </catch>
            <observe on $dgramSocket for 'socket:newDatagram' >
                <inherit>
                    $STREAM.stdout.writelines('Got socket:newDatagram event')
                </inherit>

                <choose on $dgramSocket.recvfrom('default', $STR.nr_bytes($bytes)) >
                    <inherit>
                        $STREAM.stdout.writelines("Received bytes: $?.recved")
                    </inherit>

                    <update on $result at '.recved' with $?.recved />
                    <update on $result at '.bytes' with $?.bytes />
                    <catch for `ANY`>
                        <exit with "Server failed with $?.name when calling dgramSocket.recvfrom()" />
                    </catch>
                </choose>
            </observe>
        </init>

        <load from "#client" within 'client' onto 'null:' as "client" async />

        <observe on $client for "corState:exited" >
            <exit with $result />
        </observe>

    </body>

    <body id="client">

        <init as 'dgramSocket' with $SOCKET.dgram('local:///var/tmp/hvml-dgram-client', 'nameless') >
            <catch for `ANY`>
                <exit with "Client failed with $?.name when calling SOCKET.dgram()" />
            </catch>

            <choose on $dgramSocket.sendto('local:///var/tmp/hvml-dgram-server', 'default', $bytes) >
                <inherit>
                    $STREAM.stdout.writelines("Sent bytes: $?.sent")
                </inherit>

                <sleep for '1s' />
                <exit with 'success' />
                <catch for `ANY`>
                    <exit with "Client failed with $?.name when calling dgramSocket.sendto()" />
                </catch>
            </choose>
        </init>

    </body>
</hvml>

