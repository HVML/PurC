#!/usr/bin/purc

# RESULT: [!'one message from JavaScript', 1000]

<hvml target="void">
    <head>
        <inherit on $RUNNER.enablelog('all', 'stderr') />
        <define as 'logMsg'>
            <inherit>
                $RUNNER.logmsg($?)
            </inherit>
        </define>
    </head>

    <body>

        <init as js with 'os.setTimeout(() => { console.log("time expired in JS"); hvml.fire("timeout", "one message from JavaScript", 1000); }, 1000);' />

        <inherit on $JS.load('std') />
        <inherit on $JS.eval($js) >
            <catch for `ANY`>
                <execute with $logMsg on $JS.lastError() />
            </catch>
        </inherit>

        <observe on $CRTN for 'idle'>
            <execute with $logMsg on 'On idle' />
            <test with $JS.execPending() >
                <differ>
                    <forget on $CRTN for 'idle' />
                </differ>
            </test>
        </observe>

        <observe on $JS for 'timeout'>
            <exit with $? />
        </observe>

    </body>
</hvml>

