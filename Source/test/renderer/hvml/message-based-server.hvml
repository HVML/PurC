#!/usr/bin/purc

# RESULT: 'Good Client'

<hvml target="void">
    <head>
        <define as 'logMsg'>
            $RUNNER.enablelog('all', 'stderr')

            <inherit>
                $RUNNER.logmsg($?)
            </inherit>
        </define>
    </head>

    <body id='server' >

        <include with $logMsg on 'The server is running...' />

        <init as 'msgSettings' >
            {
                'noresptimetoping': 3,
                'noresptimetoclose': 6,
            }
        </init>

        <include with $logMsg on $DATA.serialize($msgSettings) />

        <init as 'clients' with {} />

        <init as 'srvListenSocket' with $SOCKET.stream('local:///var/tmp/hvml-fake-renderer', 'none', 32) >
            <catch for `ANY`>
                <exit with "Server failed with $?.name when calling SOCKET.stream()" />
            </catch>
        </init>

        <observe on $client for "corState:exited" >
            <inherit>
                $STREAM.stdout.writelines("Client exited with $?")
            </inherit>
        </observe>

        <include with $logMsg on 'The server is accepting...' />

        <observe on $srvListenSocket for 'connAtempt'>
            <choose on $srvListenSocket.accept('default', 'message', $msgSettings)>
                <catch for `ANY`>
                    <exit with "Server failed with $?.name when calling accept()" />
                </catch>

                <test with $L.not($DATA.isequal($?, null)) >

                    <include with $logMsg on "Server accpeted a client from $?.peerAddr:$?.peerPort" />

                    <init as 'clientId' with "$?.peerAddr:$?.peerPort" temp />

                    <update on $clients to 'merge' with { $clientId : $? } />

                    <!-- TODO: send initial response to the client -->

                    <observe on $clients[$clientId] for 'message'>
                        $clientId

                        <include with $logMsg on "Server got ERROR event from `$_observedContent`; payload:" />
                        <include with $logMsg on $DATA.serialize($?) />

                        <!-- TODO: handle message here -->
                    </observe>

                    <observe on $clients[$clientId] for 'error'>
                        $clientId

                        <include with $logMsg on "Server got ERROR event from `$_observedContent`; payload:" />
                        <include with $logMsg on $DATA.serialize($?) />

                        <update on $clients at ".$_observedContent" to 'remove' />
                        <forget on $_observedOn for '*' />
                    </observe>

                    <observe on $clients[$clientId] for 'close'>
                        $clientId

                        <include with $logMsg on "Server got CLOSE event from `$_observedContent`; payload:" />
                        <include with $logMsg on $DATA.serialize($?) />

                        <update on $clients at ".$_observedContent" to 'remove' />
                        <forget on $_observedOn for '*' />
                    </observe>

                </test>
            </choose>
        </observe>

    </body>

</hvml>

